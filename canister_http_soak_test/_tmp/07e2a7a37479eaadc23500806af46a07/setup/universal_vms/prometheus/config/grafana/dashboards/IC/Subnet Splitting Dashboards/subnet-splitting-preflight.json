{
  "annotations": {
    "list": [
      {
        "$$hashKey": "object:4334",
        "builtIn": 1,
        "datasource": {
          "type": "prometheus",
          "uid": "${datasource}"
        },
        "enable": true,
        "expr": "min_over_time(    timestamp(          count by(ic_subnet) (mr_registry_version{job=\"replica\",ic=\"$ic\",ic_subnet=~\"$ic_subnet\"} >= $registry_version)        >          count by(ic_subnet) (up{job=\"replica\",ic=\"$ic\",ic_subnet=~\"$ic_subnet\"}) * 2 / 3    )[$__range:10s] ) * 1000",
        "hide": false,
        "iconColor": "rgba(0, 211, 255, 1)",
        "limit": 100,
        "name": "Registry Version Changed",
        "showIn": 0,
        "step": "10s",
        "tagKeys": "instance",
        "titleFormat": "Registry Version Changed",
        "type": "dashboard",
        "useValueForTime": true
      }
    ]
  },
  "description": "Operational support for subnet splitting. Informs when it is safe to begin the subnet split.",
  "editable": true,
  "fiscalYearStartMonth": 0,
  "graphTooltip": 1,
  "links": [
    {
      "asDropdown": true,
      "icon": "external link",
      "includeVars": true,
      "keepTime": true,
      "tags": [
        "production"
      ],
      "targetBlank": true,
      "type": "dashboards"
    },
    {
      "asDropdown": true,
      "icon": "external link",
      "includeVars": true,
      "keepTime": true,
      "tags": [
        "Subnet Splitting"
      ],
      "targetBlank": true,
      "title": "Subnet Splitting",
      "tooltip": "",
      "type": "dashboards",
      "url": ""
    }
  ],
  "liveNow": false,
  "panels": [
    {
      "datasource": {
        "type": "prometheus",
        "uid": "${datasource}"
      },
      "fieldConfig": {
        "defaults": {
          "color": {
            "mode": "palette-classic"
          },
          "custom": {
            "axisCenteredZero": false,
            "axisColorMode": "text",
            "axisLabel": "",
            "axisPlacement": "auto",
            "barAlignment": 0,
            "drawStyle": "line",
            "fillOpacity": 0,
            "gradientMode": "none",
            "hideFrom": {
              "legend": false,
              "tooltip": false,
              "viz": false
            },
            "lineInterpolation": "stepAfter",
            "lineWidth": 1,
            "pointSize": 5,
            "scaleDistribution": {
              "type": "linear"
            },
            "showPoints": "never",
            "spanNulls": false,
            "stacking": {
              "group": "A",
              "mode": "none"
            },
            "thresholdsStyle": {
              "mode": "off"
            }
          },
          "decimals": 0,
          "links": [],
          "mappings": [],
          "thresholds": {
            "mode": "absolute",
            "steps": [
              {
                "color": "green",
                "value": null
              },
              {
                "color": "red",
                "value": 80
              }
            ]
          },
          "unit": "none"
        },
        "overrides": []
      },
      "gridPos": {
        "h": 8,
        "w": 12,
        "x": 0,
        "y": 0
      },
      "id": 89,
      "interval": "10s",
      "options": {
        "legend": {
          "calcs": [],
          "displayMode": "list",
          "placement": "bottom",
          "showLegend": false
        },
        "tooltip": {
          "mode": "multi",
          "sort": "none"
        }
      },
      "pluginVersion": "9.2.5",
      "targets": [
        {
          "editorMode": "code",
          "exemplar": true,
          "expr": "label_replace(\n  floor(\n      quantile by(ic, ic_subnet) (\n        0.5,\n        mr_registry_version{job=\"replica\",ic=\"$ic\"}\n      )\n    and\n        sum by(ic, ic_subnet) (up{job=\"replica\",ic=\"$ic\"})\n      >\n        2 / 3 * count by(ic, ic_subnet) (up{job=\"replica\",ic=\"$ic\"})\n  ),\n  \"ic_subnet\", \"$1\", \"ic_subnet\", \"([^-]+)-.*\"\n)",
          "interval": "",
          "legendFormat": "{{ic_subnet}}",
          "range": true,
          "refId": "A"
        }
      ],
      "title": "Subnet Registry Versions",
      "transparent": true,
      "type": "timeseries"
    },
    {
      "datasource": {
        "type": "prometheus",
        "uid": "${datasource}"
      },
      "description": "",
      "gridPos": {
        "h": 16,
        "w": 12,
        "x": 12,
        "y": 0
      },
      "id": 85,
      "options": {
        "code": {
          "language": "plaintext",
          "showLineNumbers": false,
          "showMiniMap": false
        },
        "content": "## How to Use the Subnet Splitting Pre-Flight Dashboard\n\nThe aim  of the Subnet Splitting Pre-Flight dashboard is to inform whether it is safe\nto begin the subnet splitting.\n\nTwo conditions must hold for this:\n1. All subnets must have observed the `canister_migrations` entry for the subnet\n   split.\n2. There must be no shared state between _Subnet B_ (the subnet being created as a\n   result of the subnet split) and any other subnet. I.e. if any incoming or outgoing\n   streams exist, no messages must have been consumed from them.\n\nIn order to ensure both of the above, a third condition must hold: all subnets must\nhave had a `2f+1` quorum of live replicas exporting metrics for a significant part of\nthe selected time range (arbitrarily chosen as 50%).\n\n### Mechanics\n1. Select the IC instance.\n2. Select the subnet being created by the split (_Subnet B_).\n3. Input the registry version corresponding to the `canister_migrations` update (a\n   later registry version is also safe to use).\n4. Zoom out the dashboard time range (_Last N hours_ -> _Last N days_ -> _Last N\nweeks_) from the top right until the _Registry Version Changed_ annotation (marking the\npoint in time when the subnet switched to registry version selected at step (2) above)\nbecomes visible. It is a light blue dotted vertical line on the _Subnet Registry\nVersions_ chart.\n\nAt this point, the red/green stat panels below will show the number of subnets with old\nregistry versions; the number of _Subnet B_ streams with non-zero begin indices; and\nthe number of subnets without a live quorum. If all the stat panels show a value of `0`\nand have a green background, it is safe to proceed with subnet split.\n\nIf the value is non-zero and one or more stat panels have a red background, then the\ntable panels below will display the offending streams/subnets.\n\n### Limitations\n\nDue to Grafana / PromQL limitations, the dashboard will only look up registry versions\nfrom the selected dashboard time range. So ideally the selected range should end at\n\"Now\", rather than some fixed timestamp.\n\nIn order to make the dashboard load in reasonable time, an automatic resolution\n(resulting in around 30 data points across the time range) is used to compute the\nstream indices. This may mean e.g. that the registry versions are actually from a\ntimestamp resulting from rounding \"now\" to the resolution, rather than the most recent\navailable sample.\n\nFinally, zooming out to a longer time range will slow down the dashboard loading\ncorrespondingly. Consider zooming in to a fixed time range that covers the registry\nversion change.\n\nDo note that none of the above will cause false positives (i.e. claim that it is safe\nto proceed with the subnet split entry when it is in fact not safe). At worst, they\nmay cause false negatives (e.g. zooming in too close around the registry version change\nmay make it look like some subnets may not have observed the `canister_migrations`\nentry, when in fact they may have done so since).",
        "mode": "markdown"
      },
      "pluginVersion": "9.2.5",
      "transparent": true,
      "type": "text"
    },
    {
      "datasource": {
        "type": "datasource",
        "uid": "-- Dashboard --"
      },
      "description": "Subnets that have not yet observed the `canister_migrations` entry for the subnet split.",
      "fieldConfig": {
        "defaults": {
          "color": {
            "mode": "thresholds"
          },
          "mappings": [],
          "noValue": "0",
          "thresholds": {
            "mode": "absolute",
            "steps": [
              {
                "color": "green",
                "value": null
              },
              {
                "color": "red",
                "value": 1
              }
            ]
          }
        },
        "overrides": []
      },
      "gridPos": {
        "h": 8,
        "w": 4,
        "x": 0,
        "y": 8
      },
      "id": 104,
      "interval": "10s",
      "options": {
        "colorMode": "background",
        "graphMode": "none",
        "justifyMode": "auto",
        "orientation": "auto",
        "reduceOptions": {
          "calcs": [
            "lastNotNull"
          ],
          "fields": "",
          "values": false
        },
        "text": {},
        "textMode": "auto"
      },
      "pluginVersion": "9.2.5",
      "targets": [
        {
          "datasource": {
            "type": "datasource",
            "uid": "-- Dashboard --"
          },
          "panelId": 71,
          "refId": "A",
          "withTransforms": false
        }
      ],
      "title": "Old Registry Versions",
      "transformations": [
        {
          "id": "reduce",
          "options": {
            "labelsToFields": false,
            "reducers": [
              "count"
            ]
          }
        }
      ],
      "transparent": true,
      "type": "stat"
    },
    {
      "datasource": {
        "type": "datasource",
        "uid": "-- Dashboard --"
      },
      "description": "Number of streams to or from `${ic_subnet}` with a non-zero begin index.",
      "fieldConfig": {
        "defaults": {
          "color": {
            "mode": "thresholds"
          },
          "mappings": [],
          "noValue": "0",
          "thresholds": {
            "mode": "absolute",
            "steps": [
              {
                "color": "green",
                "value": null
              },
              {
                "color": "red",
                "value": 1
              }
            ]
          }
        },
        "overrides": []
      },
      "gridPos": {
        "h": 8,
        "w": 4,
        "x": 4,
        "y": 8
      },
      "id": 96,
      "interval": "10s",
      "options": {
        "colorMode": "background",
        "graphMode": "none",
        "justifyMode": "auto",
        "orientation": "auto",
        "reduceOptions": {
          "calcs": [
            "lastNotNull"
          ],
          "fields": "",
          "values": false
        },
        "text": {},
        "textMode": "auto"
      },
      "pluginVersion": "9.2.5",
      "targets": [
        {
          "datasource": {
            "type": "datasource",
            "uid": "-- Dashboard --"
          },
          "panelId": 97,
          "refId": "A",
          "withTransforms": false
        }
      ],
      "title": "Shared State",
      "transformations": [
        {
          "id": "reduce",
          "options": {
            "reducers": [
              "count"
            ]
          }
        }
      ],
      "transparent": true,
      "type": "stat"
    },
    {
      "datasource": {
        "type": "datasource",
        "uid": "-- Dashboard --"
      },
      "description": "Subnets (other than `${ic_subnet}`) that did not have a `2f+1` quorum for at least half the selected time range.",
      "fieldConfig": {
        "defaults": {
          "color": {
            "mode": "thresholds"
          },
          "mappings": [],
          "noValue": "0",
          "thresholds": {
            "mode": "absolute",
            "steps": [
              {
                "color": "green",
                "value": null
              },
              {
                "color": "red",
                "value": 1
              }
            ]
          }
        },
        "overrides": []
      },
      "gridPos": {
        "h": 8,
        "w": 4,
        "x": 8,
        "y": 8
      },
      "id": 103,
      "interval": "10s",
      "options": {
        "colorMode": "background",
        "graphMode": "none",
        "justifyMode": "auto",
        "orientation": "auto",
        "reduceOptions": {
          "calcs": [
            "lastNotNull"
          ],
          "fields": "",
          "values": false
        },
        "text": {},
        "textMode": "auto"
      },
      "pluginVersion": "9.2.5",
      "targets": [
        {
          "datasource": {
            "type": "datasource",
            "uid": "-- Dashboard --"
          },
          "panelId": 102,
          "refId": "A",
          "withTransforms": false
        }
      ],
      "title": "No Quorum",
      "transformations": [
        {
          "id": "reduce",
          "options": {
            "reducers": [
              "count"
            ]
          }
        }
      ],
      "transparent": true,
      "type": "stat"
    },
    {
      "datasource": {
        "type": "prometheus",
        "uid": "${datasource}"
      },
      "description": "Shared state (incoming streams with non-zero stream begin indices or any outgoing streams) for subnet `${ic_subnet}`.",
      "fieldConfig": {
        "defaults": {
          "color": {
            "mode": "thresholds"
          },
          "custom": {
            "align": "auto",
            "displayMode": "auto",
            "filterable": false,
            "inspect": false
          },
          "links": [],
          "mappings": [],
          "thresholds": {
            "mode": "absolute",
            "steps": [
              {
                "color": "green",
                "value": null
              },
              {
                "color": "red",
                "value": 80
              }
            ]
          }
        },
        "overrides": []
      },
      "gridPos": {
        "h": 12,
        "w": 8,
        "x": 0,
        "y": 16
      },
      "id": 97,
      "interval": "10s",
      "options": {
        "footer": {
          "fields": "",
          "reducer": [
            "sum"
          ],
          "show": false
        },
        "frameIndex": 0,
        "showHeader": true,
        "sortBy": [
          {
            "desc": false,
            "displayName": "From subnet"
          }
        ]
      },
      "pluginVersion": "9.2.5",
      "targets": [
        {
          "editorMode": "code",
          "exemplar": true,
          "expr": "max_over_time(\n  (\n      (\n          # Outgoing streams (implying the existence of at least one message).\n          ceil(\n            quantile by(ic_subnet, remote) (\n              0.5,\n              mr_stream_begin{job=\"replica\",ic=\"$ic\",ic_subnet=\"$ic_subnet\"}\n            )\n          )\n        or\n          # Incoming streams with non-zero begin index.\n          ceil(\n              quantile by(ic_subnet, remote) (\n                0.5,\n                mr_stream_begin{job=\"replica\",ic=\"$ic\",ic_subnet!=\"$ic_subnet\",remote=\"$ic_subnet\"}\n              )\n            >\n              0\n          )\n      )\n    and on(ic_subnet)\n      # `2*f+1` quorum\n        sum by(ic_subnet) (up{job=\"replica\",ic=\"$ic\"})\n      >\n        count by(ic_subnet) (up{job=\"replica\",ic=\"$ic\"}) * 2 / 3\n  )[$__range:$resolution]\n)",
          "format": "table",
          "instant": true,
          "interval": "",
          "legendFormat": "",
          "refId": "A"
        }
      ],
      "title": "Subnet `${ic_subnet}` Shared State",
      "transformations": [
        {
          "id": "organize",
          "options": {
            "excludeByName": {
              "Time": true,
              "Value #C": true,
              "ic_subnet": false,
              "remote": false
            },
            "indexByName": {},
            "renameByName": {
              "Difference": "",
              "Value": "Stream begin",
              "Value #A": "Stream end at migration",
              "Value #B": "Stream start \"now\"",
              "Value #C": "Streams in existence at range start",
              "ic_subnet": "From subnet",
              "remote": "To subnet"
            }
          }
        }
      ],
      "transparent": true,
      "type": "table"
    },
    {
      "datasource": {
        "type": "prometheus",
        "uid": "${datasource}"
      },
      "description": "Subnets (other than `${ic_subnet}`) without a `2f+1` quorum for at least half of the selected time range.",
      "fieldConfig": {
        "defaults": {
          "color": {
            "mode": "thresholds"
          },
          "custom": {
            "align": "auto",
            "displayMode": "auto",
            "filterable": false,
            "inspect": false
          },
          "links": [],
          "mappings": [],
          "thresholds": {
            "mode": "absolute",
            "steps": [
              {
                "color": "green",
                "value": null
              },
              {
                "color": "red",
                "value": 80
              }
            ]
          }
        },
        "overrides": []
      },
      "gridPos": {
        "h": 12,
        "w": 4,
        "x": 8,
        "y": 16
      },
      "id": 102,
      "interval": "10s",
      "options": {
        "footer": {
          "fields": "",
          "reducer": [
            "sum"
          ],
          "show": false
        },
        "frameIndex": 0,
        "showHeader": true,
        "sortBy": [
          {
            "desc": false,
            "displayName": "Subnet"
          }
        ]
      },
      "pluginVersion": "9.2.5",
      "targets": [
        {
          "editorMode": "code",
          "exemplar": true,
          "expr": "  # Below quorum samples\n  count_over_time(\n    (\n      # `2f+1` quorum\n        sum by(ic_subnet) (up{job=\"replica\",ic=\"$ic\",ic_subnet!=\"$ic_subnet\"})\n      <\n        count by(ic_subnet) (up{job=\"replica\",ic=\"$ic\",ic_subnet!=\"$ic_subnet\"}) * 2 / 3\n    )[$__range:$resolution]\n  )\n>\n  # Expected samples\n  count_over_time(\n    (\n      count by(ic_subnet) (up{job=\"replica\",ic=\"$ic\",ic_subnet!=\"$ic_subnet\"})\n    )[$__range:$resolution]\n  )\n*\n  .5",
          "format": "table",
          "instant": true,
          "interval": "",
          "legendFormat": "",
          "refId": "A"
        }
      ],
      "title": "Subnets without a quorum",
      "transformations": [
        {
          "id": "organize",
          "options": {
            "excludeByName": {
              "Time": true,
              "Value": true,
              "Value #C": true,
              "ic_subnet": false,
              "remote": false
            },
            "indexByName": {},
            "renameByName": {
              "Difference": "",
              "Value": "Samples",
              "Value #A": "Stream end at migration",
              "Value #B": "Stream start \"now\"",
              "Value #C": "Streams in existence at range start",
              "ic_subnet": "Subnet",
              "remote": "To subnet"
            }
          }
        }
      ],
      "transparent": true,
      "type": "table"
    },
    {
      "datasource": {
        "type": "prometheus",
        "uid": "${datasource}"
      },
      "description": "Subnets that have not yet observed the `canister_migrations` entry for the subnet split.",
      "fieldConfig": {
        "defaults": {
          "color": {
            "mode": "thresholds"
          },
          "custom": {
            "align": "auto",
            "displayMode": "auto",
            "inspect": false
          },
          "decimals": 0,
          "links": [],
          "mappings": [],
          "thresholds": {
            "mode": "absolute",
            "steps": [
              {
                "color": "green",
                "value": null
              },
              {
                "color": "red",
                "value": 80
              }
            ]
          },
          "unit": "none"
        },
        "overrides": []
      },
      "gridPos": {
        "h": 12,
        "w": 12,
        "x": 12,
        "y": 16
      },
      "id": 71,
      "interval": "10s",
      "options": {
        "footer": {
          "fields": "",
          "reducer": [
            "sum"
          ],
          "show": false
        },
        "showHeader": true,
        "sortBy": [
          {
            "desc": false,
            "displayName": "ic_subnet"
          }
        ]
      },
      "pluginVersion": "9.2.5",
      "targets": [
        {
          "editorMode": "code",
          "exemplar": false,
          "expr": "  floor(\n      quantile by(ic, ic_subnet) (\n        0.5,\n        mr_registry_version{job=\"replica\",ic=\"$ic\",ic_subnet!=\"$ic_subnet\"}\n      )\n    and\n        sum by(ic, ic_subnet) (up{job=\"replica\",ic=\"$ic\",ic_subnet!=\"$ic_subnet\"})\n      >\n        2 / 3 * count by(ic, ic_subnet) (up{job=\"replica\",ic=\"$ic\",ic_subnet!=\"$ic_subnet\"})\n  )\n<\n  $registry_version",
          "format": "table",
          "instant": true,
          "interval": "",
          "legendFormat": "{{ic_subnet}}",
          "range": false,
          "refId": "A"
        }
      ],
      "title": "Subnets with Old Registry Versions",
      "transformations": [
        {
          "id": "organize",
          "options": {
            "excludeByName": {
              "Time": true,
              "ic": true
            },
            "indexByName": {},
            "renameByName": {
              "Value": "Registry Version",
              "ic_subnet": "Subnet"
            }
          }
        }
      ],
      "transparent": true,
      "type": "table"
    }
  ],
  "refresh": false,
  "schemaVersion": 37,
  "style": "dark",
  "tags": [
    "Subnet Splitting"
  ],
  "templating": {
    "list": [
      {
        "current": {
          "selected": false,
          "text": "IC Metrics (cluster local)",
          "value": "IC Metrics (cluster local)"
        },
        "hide": 0,
        "includeAll": false,
        "multi": false,
        "name": "datasource",
        "options": [],
        "query": "prometheus",
        "queryValue": "",
        "refresh": 1,
        "regex": "/IC.*/",
        "skipUrlSync": false,
        "type": "datasource"
      },
      {
        "current": {
          "selected": false,
          "text": "mercury",
          "value": "mercury"
        },
        "datasource": {
          "type": "prometheus",
          "uid": "${datasource}"
        },
        "definition": "label_values(ic)",
        "hide": 0,
        "includeAll": false,
        "label": "IC",
        "multi": false,
        "name": "ic",
        "options": [],
        "query": {
          "query": "label_values(ic)",
          "refId": "prometheus-ic-Variable-Query"
        },
        "refresh": 2,
        "regex": "",
        "skipUrlSync": false,
        "sort": 1,
        "tagValuesQuery": "",
        "tagsQuery": "",
        "type": "query",
        "useTags": false
      },
      {
        "allValue": ".+",
        "current": {
          "selected": false,
          "text": "tdb26-jop6k-aogll-7ltgs-eruif-6kk7m-qpktf-gdiqx-mxtrf-vb5e6-eqe",
          "value": "tdb26-jop6k-aogll-7ltgs-eruif-6kk7m-qpktf-gdiqx-mxtrf-vb5e6-eqe"
        },
        "datasource": {
          "type": "prometheus",
          "uid": "${datasource}"
        },
        "definition": "label_values(up{ic=\"$ic\"},ic_subnet)",
        "description": "Subnet that will result from the split",
        "hide": 0,
        "includeAll": false,
        "label": "Subnet B",
        "multi": false,
        "name": "ic_subnet",
        "options": [],
        "query": {
          "query": "label_values(up{ic=\"$ic\"},ic_subnet)",
          "refId": "prometheus-ic_subnet-Variable-Query"
        },
        "refresh": 2,
        "regex": "",
        "skipUrlSync": false,
        "sort": 1,
        "tagValuesQuery": "",
        "tagsQuery": "",
        "type": "query",
        "useTags": false
      },
      {
        "current": {
          "selected": true,
          "text": "35885",
          "value": "35885"
        },
        "description": "Registry version when `canister_migrations` entry was added.",
        "hide": 0,
        "label": "`canister_migrations` registry version",
        "name": "registry_version",
        "options": [
          {
            "selected": true,
            "text": "35885",
            "value": "35885"
          }
        ],
        "query": "35885",
        "skipUrlSync": false,
        "type": "textbox"
      },
      {
        "auto": true,
        "auto_count": 30,
        "auto_min": "1m",
        "current": {
          "selected": false,
          "text": "auto",
          "value": "$__auto_interval_resolution"
        },
        "hide": 0,
        "label": "Resolution",
        "name": "resolution",
        "options": [
          {
            "selected": true,
            "text": "auto",
            "value": "$__auto_interval_resolution"
          },
          {
            "selected": false,
            "text": "1m",
            "value": "1m"
          },
          {
            "selected": false,
            "text": "10m",
            "value": "10m"
          },
          {
            "selected": false,
            "text": "30m",
            "value": "30m"
          },
          {
            "selected": false,
            "text": "1h",
            "value": "1h"
          },
          {
            "selected": false,
            "text": "6h",
            "value": "6h"
          },
          {
            "selected": false,
            "text": "12h",
            "value": "12h"
          },
          {
            "selected": false,
            "text": "1d",
            "value": "1d"
          }
        ],
        "query": "1m,10m,30m,1h,6h,12h,1d",
        "queryValue": "",
        "refresh": 2,
        "skipUrlSync": false,
        "type": "interval"
      }
    ]
  },
  "time": {
    "from": "now-30m",
    "to": "now"
  },
  "timepicker": {
    "refresh_intervals": [
      "5s",
      "10s",
      "30s",
      "1m",
      "5m",
      "15m",
      "30m",
      "1h",
      "2h",
      "1d"
    ]
  },
  "timezone": "utc",
  "title": "Subnet Splitting Pre-Flight",
  "uid": "subnet-splitting-preflight",
  "weekStart": ""
}
