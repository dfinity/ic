# Darwin tests on runners from https://namespace.so
name: test-namespace
on: [push]
jobs:
  test-namespace:
    strategy:
      matrix:
        os: [ namespace-profile-darwin-small ] # profile created in namespace console
    runs-on: ${{ matrix.os }}
    steps:

      - name: Install nsc
        run: |
          # A recent version is required for `nsc bazel cache setup`
          curl -fsSL https://get.namespace.so/cloud/install.sh | sh -s -- --version 0.0.386

      - name: Set up Bazel cache
        run: |
          # Creates a bazelrc configuration fragment which tells bazel where the cache lives.
          nsc bazel cache setup --bazelrc=/tmp/bazel-cache.bazelrc

      - uses: actions/checkout@v4

      # Build and test, excluding 'upload' jobs that are not required on macOS (used in reproducibility tests)
      - name: Test
        run: |
          bazel \
            --noworkspace_rc \
            --bazelrc=./bazel/conf/.bazelrc.build --bazelrc=/tmp/bazel-cache.bazelrc \
            test \
            --config=ci --config=macos_ci \
            --test_tag_filters="test_macos,-upload" \
            //rs/... //publish/binaries/...
