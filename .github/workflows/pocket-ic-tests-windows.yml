name: PocketIC Windows
on:
  # called from ci-main and schedule-daily workflows
  workflow_call:
    inputs:
      commit-sha:
        description: The commit sha to run the CI on
        required: true
        type: string

jobs:
  run-pocket-ic-tests:
    name: Check Run PocketIC Tests
    runs-on: ubuntu-latest
    outputs:
      run-pocket-ic-tests: ${{ steps.set-output.outputs.run-pocket-ic-tests }}
    steps:
      - name: Filter Relevant Files
        uses: dorny/paths-filter@de90cc6fb38fc0963ad72b210f1f284cd68cea36 # v3
        id: filter
        if: ${{ github.event_name == 'pull_request' }}
        with:
          filters: |
            pocket-ic:
              - .github/workflows/pocket-ic-tests-windows.yml
              - packages/pocket-ic/**
              - rs/pocket_ic_server/**
      - name: Check Run Conditions
        id: set-output
        shell: bash
        run: |
          set -euo pipefail
          # if it is a pull request, only run if relevant files changed
          if [ "${{ github.event_name }}" == "pull_request" ]; then
            if [ "${{ steps.filter.outputs.pocket-ic }}" == "true" ]; then
              echo "run-pocket-ic-tests=true" >> "$GITHUB_OUTPUT"
            else
              echo "run-pocket-ic-tests=false" >> "$GITHUB_OUTPUT"
            fi
          # for any other event (like triggered by a schedule), run regardless of changed files
          else
            echo "run-pocket-ic-tests=true" >> "$GITHUB_OUTPUT"
          fi

  bazel-build-pocket-ic:
    name: Bazel Build PocketIC
    container:
      image: ghcr.io/dfinity/ic-build@sha256:73a39bf88685ab3dfa2649c66bf30c483b1ae69fac7d6346cc229ef7e22f334e
      options: >-
        -e NODE_NAME --privileged --cgroupns host --mount type=tmpfs,target="/home/buildifier/.local/share/containers"
    timeout-minutes: 90
    runs-on:
      labels: dind-large
    needs: [run-pocket-ic-tests]
    if: ${{ needs.run-pocket-ic-tests.outputs.run-pocket-ic-tests == 'true' }}
    steps:
      - &checkout
        name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.commit-sha }}
      - name: Build PocketIC server
        run: |
          bazel build //rs/pocket_ic_server:pocket-ic-server
      - name: Compute PocketIC server path
        id: pocket-ic-server-path
        run: echo "pocket_ic_server_path=$(bazel cquery //rs/pocket_ic_server:pocket-ic-server --output=files)" >> $GITHUB_OUTPUT
      - name: Upload PocketIC server
        uses: actions/upload-artifact@v4
        with:
          name: pocket-ic-server
          path: ${{ steps.pocket-ic-server-path.outputs.pocket_ic_server_path }}
      - name: Build PocketIC test canister
        run: |
          bazel build //packages/pocket-ic/test_canister:test_canister
      - name: Compute PocketIC test canister path
        id: pocket-ic-test-canister-path
        run: echo "pocket_ic_test_canister_path=$(bazel cquery //packages/pocket-ic/test_canister:test_canister --output=files)" >> $GITHUB_OUTPUT
      - name: Upload PocketIC test canister
        uses: actions/upload-artifact@v4
        with:
          name: pocket-ic-test-canister
          path: ${{ steps.pocket-ic-test-canister-path.outputs.pocket_ic_test_canister_path }}

  pocket-ic-lint-on-windows:
    name: PocketIC Lint on Windows
    runs-on: windows-2022
    needs: [run-pocket-ic-tests]
    if: ${{ needs.run-pocket-ic-tests.outputs.run-pocket-ic-tests == 'true' }}
    steps:
      - *checkout
      - name: Linting
        run: |
          cargo clippy -p pocket-ic --locked --all-features --all-targets -- -D warnings -D clippy::all -D clippy::mem_forget -C debug-assertions=off -A clippy::uninlined_format_args

  pocket-ic-tests-on-windows:
    name: PocketIC Tests on Windows
    needs: [bazel-build-pocket-ic]
    runs-on: windows-2022
    steps:
      - *checkout
      - name: Download PocketIC server
        uses: actions/download-artifact@v4
        with:
          name: pocket-ic-server
      - name: Download PocketIC test canister
        uses: actions/download-artifact@v4
        with:
          name: pocket-ic-test-canister
      - name: Setup WSLv2
        uses: Vampire/setup-wsl@6a8db447be7ed35f2f499c02c6e60ff77ef11278
        with:
          distribution: Ubuntu-24.04
          wsl-version: 2
      - name: Tests
        run: |
          $env:WORKDIR=(Get-Location).Path
          $env:RUST_TEST_THREADS=2
          $env:POCKET_IC_BIN="$env:WORKDIR\pocket-ic-server"
          $env:TEST_WASM="$env:WORKDIR\test_canister.wasm.gz"
          cargo test --locked -p pocket-ic
