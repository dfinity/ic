name: Schedule Weekly

on:
  # Schedule is temporarily disabled as Clusterfuzz is not active anymore
  # schedule:
  #   - cron: "0 8 * * 3"
  workflow_dispatch:

jobs:
  bazel-build-fuzzers-weekly:
    runs-on:
      labels: dind-large
    container:
      image: ghcr.io/dfinity/ic-build@sha256:983a02b1360e0215d519e749c4393c9c0f31589a461e992bf4b693cc30363320
      options: >-
        -e NODE_NAME --mount type=tmpfs,target="/home/buildifier/.local/share/containers"
    timeout-minutes: 60 # 1 hour
    environment: Weekly Tests
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Before script
        id: before-script
        shell: bash
        run: |
          [ -n "${NODE_NAME:-}" ] && echo "Node: $NODE_NAME"
      - name: Authenticate GCloud
        id: 'auth'
        uses: 'google-github-actions/auth@7c6bc770dae815cd3e89ee6cdf493a5fab2cc093' # v3 latest
        with:
          credentials_json: '${{ secrets.FUZZING_GCP_SERVICE_KEY }}'
      - name: 'Set up Cloud SDK'
        uses: 'google-github-actions/setup-gcloud@aa5489c8933f4cc7a4f7d45035b3b1440c9c10db' # v3.0.1
      - name: Build and Push Fuzzers to GCP
        shell: bash
        run: |
          cd bin/fuzzing/
          ./build-all-fuzzers.sh --zip
          cd fuzzer_build
          gcloud storage cp libfuzzer_asan_linux_*.zip gs://ic_fuzzer_builds
          gcloud storage cp afl_asan_linux_*.zip gs://ic_fuzzer_builds
