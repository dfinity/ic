name: Schedule Weekly

on:
  schedule:
    - cron: "0 8 * * 3"
  workflow_dispatch:

jobs:
  bazel-build-fuzzers-weekly:
    runs-on:
      labels: dind-large
    container:
      image: ghcr.io/dfinity/ic-build@sha256:f9765e0dec9785bcabd3694939cb129899161809046ac132b9e9794b82b3c872
      options: >-
        -e NODE_NAME --mount type=tmpfs,target="/home/buildifier/.local/share/containers"
    timeout-minutes: 60 # 1 hour
    environment: Weekly Tests
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Before script
        id: before-script
        shell: bash
        run: |
          [ -n "${NODE_NAME:-}" ] && echo "Node: $NODE_NAME"
      - name: Install gsutil
        shell: bash
        run: |
          echo "deb [signed-by=/usr/share/keyrings/cloud.google.gpg] http://packages.cloud.google.com/apt cloud-sdk main" | tee -a /etc/apt/sources.list.d/google-cloud-sdk.list
          curl https://packages.cloud.google.com/apt/doc/apt-key.gpg | apt-key --keyring /usr/share/keyrings/cloud.google.gpg  add -
          apt -yqq install --no-install-recommends google-cloud-cli gcc-$(gcc --version|head -n1|sed 's/\..*//'|sed 's/.* //')-plugin-dev libstdc++-$(gcc --version|head -n1|sed 's/\..*//'|sed 's/.* //')-dev
          gsutil --version
      - name: Load Service Account Key to file
        env:
          FUZZING_GCP_SERVICE_KEY: ${{ secrets.FUZZING_GCP_SERVICE_KEY }}
        run: |
          echo $FUZZING_GCP_SERVICE_KEY | base64 --decode > bin/fuzzing/fuzzing_service_account.json
      - name: Build and Push Fuzzers to GCP
        shell: bash
        run: |
          cd bin/fuzzing/
          gcloud auth activate-service-account --key-file fuzzing_service_account.json
          ./build-all-fuzzers.sh --zip
          cd fuzzer_build
          gsutil -m cp libfuzzer_asan_linux_*.zip gs://ic_fuzzer_builds
          gsutil -m cp afl_asan_linux_*.zip gs://ic_fuzzer_builds
