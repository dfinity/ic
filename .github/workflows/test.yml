name: build-and-test
on: [push]
jobs:
  build-and-test:
    strategy:
      matrix:
        os: [ namespace-profile-darwin-small ]
    runs-on: ${{ matrix.os }}
    steps:

      - name: Install latest nsc
        run: |
          # The latest nsc version is required for `nsc bazel cache setup`
          curl -fsSL https://get.namespace.so/cloud/install.sh | sh -s -- --version 0.0.386

      - name: Set up Bazel cache
        run: |
          # Creates a bazelrc configuration fragment which tells bazel where the cache lives.
          nsc bazel cache setup --bazelrc=/tmp/bazel-cache.bazelrc

      - uses: actions/checkout@v4

        #- name: ANALYZE
        #  run: |
        #    bazel --noworkspace_rc --bazelrc=./bazel/conf/.bazelrc.build --bazelrc=/tmp/bazel-cache.bazelrc build --config=ci --config=macos_ci //rs/... //publish/binaries/... --nobuild

        #- name: BUILD
        #  run: |
        #    bazel --noworkspace_rc --bazelrc=./bazel/conf/.bazelrc.build --bazelrc=/tmp/bazel-cache.bazelrc build --config=ci --config=macos_ci //rs/... //publish/binaries/...

      - name: TEST
        run: |
          bazel \
            --noworkspace_rc \
            --bazelrc=./bazel/conf/.bazelrc.build --bazelrc=/tmp/bazel-cache.bazelrc \
            test \
            --config=ci --config=macos_ci \
            --build_tag_filters="test_macos,-upload" \
            --test_tag_filters="test_macos,-upload" \
            //rs/... //publish/binaries/...
