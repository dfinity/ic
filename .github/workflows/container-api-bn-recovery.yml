name: Container API BN Recovery Image

on:
  schedule:
    - cron: "0 8 * * 4"
  workflow_dispatch:
  pull_request:
    paths:
      - '.github/workflows/container-api-bn-recovery.yml'
      - 'ic-os/api-bn-recovery/Dockerfile'
      - 'ic-os/api-bn-recovery/entrypoint.sh'

concurrency:
  group: ${{ github.workflow }}-${{ github.head_ref || github.run_id }}
  cancel-in-progress: true

permissions:
  contents: read
  packages: write

defaults:
  run:
    shell: bash

jobs:
  build-and-push:
    name: Build and Push API BN Recovery Image
    runs-on:
      labels: dind-large
    container:
      image: ghcr.io/dfinity/ic-build@sha256:2caf6df6009b29ede72a520b60f3db064324e22192be532349caa82a987f8c50
      options: >-
        -e NODE_NAME --privileged --cgroupns host
        --mount type=tmpfs,target="/home/buildifier/.local/share/containers"
    timeout-minutes: 60
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Build binaries with Bazel
        uses: ./.github/actions/bazel
        with:
          run: |
            bazel build \
              //rs/boundary_node/ic_boundary:ic-boundary \
              //rs/orchestrator/registry_replicator:ic-registry-replicator

      - name: Prepare build context
        run: |
          set -euo pipefail
          cp bazel-bin/rs/boundary_node/ic_boundary/ic-boundary ic-os/api-bn-recovery/ic-boundary
          cp bazel-bin/rs/orchestrator/registry_replicator/ic-registry-replicator ic-os/api-bn-recovery/ic-registry-replicator
          cp ic-os/components/guestos/share/nns_public_key.pem ic-os/api-bn-recovery/nns_public_key.pem

      - name: Login to GHCR
        run: |
          mkdir -p "$HOME/.docker"
          podman login \
            --compat-auth-file="$HOME/.docker/config.json" \
            -u ${{ github.actor }} \
            -p ${{ secrets.GITHUB_TOKEN }} \
            ghcr.io

      - name: Build container image
        run: |
          set -euo pipefail
          DATE="$(date '+%Y-%m-%d')"
          SHA="${{ github.sha }}"
          SHORT_SHA="${SHA:0:9}"

          podman build \
            -t "ghcr.io/${{ github.repository_owner }}/api-boundary-node:${DATE}" \
            -t "ghcr.io/${{ github.repository_owner }}/api-boundary-node:${SHORT_SHA}" \
            -t "ghcr.io/${{ github.repository_owner }}/api-boundary-node:latest" \
            ic-os/api-bn-recovery

          echo "DATE=${DATE}" >> "$GITHUB_ENV"
          echo "SHORT_SHA=${SHORT_SHA}" >> "$GITHUB_ENV"

      - name: Push container image
        if: github.ref_name == 'master'
        run: |
          set -euo pipefail
          for tag in "${{ env.DATE }}" "${{ env.SHORT_SHA }}" latest; do
            podman push "ghcr.io/${{ github.repository_owner }}/api-boundary-node:${tag}"
          done
