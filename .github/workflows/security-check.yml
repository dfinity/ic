name: Security Check

# Currently just contains the dependency check job, but could also include more jobs for running security checks of external PRs

on:
  # Allows you to run this workflow manually from the Actions tab
  workflow_dispatch:
    inputs:
      commit-sha:
        description: The commit sha to run the CI on
        required: true
        type: string
      pr-number:
        description: 'The PR number for which the security check should run'
        required: true
        type: string
  # Used as a reusable workflow within ci-pr-only workflow
  workflow_call:
    inputs:
      commit-sha:
        description: The commit sha to run the CI on
        required: true
        type: string
      pr-number:
        description: 'The PR number for which the security check should run'
        required: false
        default: ${{ github.event.pull_request.number }}
        type: string

jobs:
  dependencies-check:
    name: Dependency Scan for PR
    runs-on: ubuntu-latest
    timeout-minutes: 60
    permissions:
      contents: read
      pull-requests: write
    env:
      SHELL_WRAPPER: "/usr/bin/time"
      CARGO_AUDIT_VERSION: "0.21.0"
      CI_MERGE_REQUEST_IID: ${{ inputs.pr-number }}
      CI_PROJECT_PATH: ${{ github.repository }}
      CI_PIPELINE_ID: ${{ github.run_id }}
      CI_COMMIT_SHA: ${{ inputs.commit-sha }}
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      JIRA_API_TOKEN: ${{ secrets.JIRA_API_TOKEN }}
      SLACK_PSEC_BOT_OAUTH_TOKEN: ${{ secrets.SLACK_PSEC_BOT_OAUTH_TOKEN }}
      REPO_NAME: ${{ github.repository }}
    steps:
      - *checkout
      - name: Filter Relevant Files
        uses: dorny/paths-filter@de90cc6fb38fc0963ad72b210f1f284cd68cea36 # v3
        id: filter
        with:
          ref: ${{ inputs.commit-sha }}
          filters: |
            depcheck:
              - '.github/workflows/ci-pr-only.yml'
              - 'bazel/external_crates.bzl'
              - '**/*.lock'
              - '**/*.toml'
      - name: Set up Python
        uses: actions/setup-python@v5
        if: steps.filter.outputs.depcheck == 'true'
        with:
          python-version: "3.12"
      - name: Setup environment deps
        id: setup-environment-deps
        if: steps.filter.outputs.depcheck == 'true'
        shell: bash
        run: |
          # Ignore externally-managed-environment pip error, install packages system-wide.
          PIP_BREAK_SYSTEM_PACKAGES=1 pip3 install --ignore-installed -r requirements.txt
          cargo install cargo-audit --version "${CARGO_AUDIT_VERSION}"
      - name: Dependency Scan for Pull Request
        id: dependencies-check
        if: steps.filter.outputs.depcheck == 'true'
        shell: bash
        run: |
          set -euo pipefail
          export PYTHONPATH=$PWD/ci/src:$PWD/ci/src/dependencies
          cd ci/src/dependencies/
          $SHELL_WRAPPER python3 job/bazel_rust_ic_scanner_merge_job.py
