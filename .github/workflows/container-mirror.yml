name: Container Image Mirroring

on:
  workflow_dispatch:
  pull_request:
    paths:
      - '.github/workflows/container-mirror.yml'
      - '.github/container-mirror/images.yml'

concurrency:
  group: ${{ github.workflow }}-${{ github.head_ref || github.run_id }}
  cancel-in-progress: true

permissions:
  pull-requests: write
  packages: write
  contents: write

jobs:
  get-images:
    name: Get Image List
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.parse-images.outputs.matrix }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Read Container Images
        id: parse-images
        run: |
          echo "Reading images.json..."
          MATRIX=$(jq -c '.images' .github/workflows/container-mirror-images.json)
          echo "matrix=$MATRIX" >> $GITHUB_OUTPUT

  mirror:
    name: Mirror Images
    runs-on: ubuntu-latest
    needs: get-images
    strategy:
      fail-fast: false
      matrix:
        include: ${{ fromJson(needs.get-images.outputs.matrix) }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Sync Containers
        run: |
          echo "Processing image ${{ matrix.image }} from repository ${{ matrix.repo }} with SHA256 ${{ matrix.sha256 }}"

