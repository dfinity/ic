name: API BN Recovery Test

on:
  workflow_dispatch:
  schedule:
    - cron: '0 6 * * 1'  # weekly on Monday at 06:00 UTC
  pull_request:
    paths:
      - '.github/workflows/api-bn-recovery-test.yml'
      - 'ic-os/api-bn-recovery/**'

concurrency:
  group: ${{ github.workflow }}-${{ github.head_ref || github.run_id }}
  cancel-in-progress: true

permissions:
  contents: read

jobs:
  test:
    name: API BN Recovery Smoke Test
    runs-on:
      labels: dind-large
    container:
      image: ghcr.io/dfinity/ic-build@sha256:2157bda72421ff05104e22333a5c1271faa41b575d7d9045930ec97494afbce7
      options: >-
        -e NODE_NAME --privileged --cgroupns host
        --mount type=tmpfs,target="/home/buildifier/.local/share/containers"
    timeout-minutes: 15
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install dfx
        run: |
          DFXVM_INIT_YES=1 sh -ci "$(curl -fsSL https://internetcomputer.org/install.sh)"
          echo "$HOME/.local/share/dfx/bin" >> "$GITHUB_PATH"

      - name: Run smoke test
        uses: ./.github/actions/bazel
        with:
          run: ./ic-os/api-bn-recovery/test.sh
