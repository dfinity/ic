name: Tag Team Reviewers

on:
  pull_request:
    types:
      - ready_for_review
      - synchronize

jobs:
  manage-tags:
    if: ${{ github.event.pull_request.draft == false }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '14'

      - name: Install dependencies
        run: npm install

      - name: Determine files changed
        id: changed_files
        run: |
          PR_NUMBER=$(echo $GITHUB_REF | awk 'BEGIN { FS = "/" } ; { print $3 }')
          echo "PR_NUMBER=$PR_NUMBER" >> $GITHUB_ENV

          CHANGED_FILES=$(gh pr view $PR_NUMBER --json files --jq '.files[].path')
          echo "CHANGED_FILES=$CHANGED_FILES" >> $GITHUB_ENV
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Determine teams to tag
        id: determine_teams
        run: |
          TEAM_TAGS=""
          for FILE in $CHANGED_FILES; do
            TEAMS=$(grep -E "^.* $FILE" .github/CODEOWNERS | awk '{print $NF}')
            for TEAM in $TEAMS; do
              TEAM_TAGS="$TEAM_TAGS team-$TEAM"
            done
          done
          TEAM_TAGS=$(echo $TEAM_TAGS | tr ' ' '\n' | sort -u | tr '\n' ' ')
          echo "TEAM_TAGS=$TEAM_TAGS" >> $GITHUB_ENV

      - name: Get current PR labels
        id: get_labels
        run: |
          CURRENT_LABELS=$(gh pr view $PR_NUMBER --json labels --jq '.labels[].name')
          echo "CURRENT_LABELS=$CURRENT_LABELS" >> $GITHUB_ENV
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Add new labels
        if: steps.determine_teams.outputs.TEAM_TAGS != ''
        run: |
          for TAG in $TEAM_TAGS; do
            if [[ ! " $CURRENT_LABELS " =~ " $TAG " ]]; then
              gh pr edit $PR_NUMBER --add-label "$TAG"
            fi
          done
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Remove obsolete labels
        run: |
          for LABEL in $CURRENT_LABELS; do
            if [[ $LABEL == team-* ]] && [[ ! " $TEAM_TAGS " =~ " $LABEL " ]]; then
              gh pr edit $PR_NUMBER --remove-label "$LABEL"
            fi
          done
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
