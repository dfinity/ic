name: tmu-trivy-debug

on:
  pull_request:

jobs:
  tmu-trivy-debug:
    name: tmu-trivy-debug
    runs-on: &dind-large-setup
      labels: dind-large
    container: &container-setup
      image: ghcr.io/dfinity/ic-build@sha256:ece16fc265918da396aa2cbe8d4114c614de9328a49c7cca86a22d53d47ad633
      options: >-
        -e NODE_NAME --privileged --cgroupns host --mount type=tmpfs,target="/home/buildifier/.local/share/containers"
    steps:
      - *checkout
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"
      - name: Setup environment deps
        id: setup-environment-deps
        shell: bash
        run: |
          pwd
          ls -la
          # this is needed to get more free space on the runner, otherwise might run OOM when building icOS
          rm -rf /opt/hostedtoolcache
          # Ignore externally-managed-environment pip error, install packages system-wide.
          PIP_BREAK_SYSTEM_PACKAGES=1 pip3 install --ignore-installed -r requirements.txt
      - name: Run Dependency Scan Nightly
        id: dependency-scan-nightly
        shell: bash
        run: |
          set -euo pipefail
          export PYTHONPATH=$PWD/ci/src:$PWD/ci/src/dependencies
          cd ci/src/dependencies/
          cp -a $GITHUB_WORKSPACE/config/. config/
          $SHELL_WRAPPER python3 job/bazel_trivy_test.py
          df -h
        env:
          SHELL_WRAPPER: "/usr/bin/time"
          CI_PIPELINE_ID: ${{ github.run_id }}
