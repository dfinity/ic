name: 'Bazel action'
description: |
    An action for running bazel commands with extra, CI-specific options.
inputs:
  run:
    required: true
    description: |
      The commands to run. Will be evaluated with bash.
  execlog-artifact-name:
    required: false
  GPG_PASSPHRASE:
    required: true
    description: "GPG key to encrypt build events. Upload can be disabled by explicitly setting the input to an empty string."

runs:
  using: "composite"
  steps:

    # Create a known tempdir where build events will be written
    - id: metrics-tmpdir
      shell: bash
      run: |
        metrics_out=$(mktemp -d)
        echo "dir=$metrics_out" >> $GITHUB_OUTPUT


    # Run the specified commands
    - name: Run bazel commands
      shell: bash
      env:
        # Used by the bazel wrapper
        BUILDBUDDY_LINKS: '[CI Job](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})'
      run: |
        set -euo pipefail

        # Here we overwrite the PATH with our custom bazel wrapper to ensure
        # the specified commands are run with the CI-specific options included
        # in the wrapper.
        export BAZEL_ACTION_OLDPATH="$PATH"
        # github.action_path doesn't seem to work
        PATH="$PWD/.github/actions/bazel/bin:$BAZEL_ACTION_OLDPATH"
        hash -r

        # Used by the bazel wrapper
        export BAZEL_ACTION_METRICS_OUT='${{ steps.metrics-tmpdir.outputs.dir }}'

        ${{ inputs.run }}

    # Look for files generated by the build
    - name: Encrypt build events
      shell: bash
      # only upload on success or failure but _not_ on canceled jobs
      if: (success() || failure()) && inputs.GPG_PASSPHRASE != ''
      run: |
        for bep in $(find '${{ steps.metrics-tmpdir.outputs.dir }}' -name 'bazel-bep-*.pb'); do
            gpg --symmetric --cipher-algo AES256 -o "$bep.gpg" \
                --passphrase '${{ inputs.GPG_PASSPHRASE }}' --batch --yes "$bep"
            rm -f "$bep"
        done

    - name: Upload bazel-bep
      # runs only if previous steps succeeded or failed;
      # we avoid collecting artifacts of jobs that were cancelled
      if: success() || failure()
      uses: actions/upload-artifact@v4
      with:
        name: ${{ github.job }}-bep
        retention-days: 14
        if-no-files-found: ignore
        compression-level: 9
        path: |
          ${{ steps.metrics-tmpdir.outputs.dir }}/bazel-bep-*.pb.gpg
          ${{ steps.metrics-tmpdir.outputs.dir }}/profile-*.json


          # TODO: time this
    - name: Clean up execlog
      shell: bash
      if: (success() || failure()) && inputs.execlog-artifact-name != ''
      run: |
        # todo: extract this
        execlog_path='${{ steps.metrics-tmpdir.outputs.dir }}/execution_log.json'
        if ! [ -e "$execlog_path" ]; then
          exit 0
        fi

        execlog_tmp=$(mktemp)

        time jq -cMr <"$execlog_path" \
            '. | .targetLabel as $targetLabel | select(.targetLabel | test(".*")) | .actualOutputs | map(. | {"path": .path, "hash": .digest.hash, "targetLabel": $targetLabel}) | .[] | .targetLabel+","+.path+","+.hash' > "$execlog_tmp"

        mv "$execlog_tmp" "$execlog_path"

    - name: Upload execution log
      if: (success() || failure()) && inputs.execlog-artifact-name != ''
      uses: actions/upload-artifact@v4
      with:
        name: ${{ inputs.execlog-artifact-name }}
        if-no-files-found: ignore
        path: |
          ${{ steps.metrics-tmpdir.outputs.dir }}/execution_log.json

    - name: Cleanup
      shell: bash
      if: always()
      run: |
        rm -rf '${{ steps.metrics-tmpdir.outputs.dir }}'
