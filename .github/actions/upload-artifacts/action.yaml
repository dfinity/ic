name: Upload Artifacts
description: |
  Run an artifact upload command and set a step summary. This expects the upload command to write one line per artifact to stdout.
inputs:
  upload-command:
    required: true
  name:
    required: true

runs:
  using: "composite"
  steps:
    - name: Upload to S3
      uses: ./.github/actions/bazel
      with:
        run: |
          echo uploading artifacts to remote storage
          upload_output=$(mktemp) # used in summary

          ${{ inputs.upload-command }} >"$upload_output"

          n_uploaded=$(wc -l <"$upload_output")
          echo "'$n_uploaded' artifacts uploaded"

          # the upload list can get quite big, so we wrap it in details/summary
          {
            echo '<details><summary>Uploaded '"$n_uploaded"' Artifacts for ${{ inputs.name }}</summary>';
            echo
            echo '```'
            cat "$upload_output"
            echo '```'
            echo
            echo '</details>';
          } >>"$GITHUB_STEP_SUMMARY"

          rm "$upload_output"
