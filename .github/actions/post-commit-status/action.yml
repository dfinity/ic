name: 'Post Commit Status'
description: |
    An action for checking and posting the commit status.
inputs:
  commit-sha:
    required: true
    description: |
      The SHA of the commit to check the status for.
  run-result:
    required: true
    description: |
      The result of the CI main job (success, failure, etc).
  name:
    required: true
    description: |
      The name of the workflow that produced the result.
  event_name:
    required: false
    description: |
      The name of the event that triggered the workflow (e.g., 'pull_request').

runs:
  using: "composite"
  steps:      
    - uses: actions/github-script@v7
      with:
        script: |
          let state, description;

          if ('${{ inputs.run-result }}' === 'success') {
            state = 'success';
            description = 'Required checks passed';

          } else if ('${{ inputs.run-result }}' === 'failure') {
            state = 'failure';
            description = 'Required checks failed';

          } else if ('${{ inputs.run-result }}' === 'skipped') {
            description = '${{ inputs.name }} checks were skipped';

            // On pull requests, skipped checks are treated as failures to ensure the PR is blocked 
            if ('${{ inputs.event_name }}' === 'pull_request') {
              state = 'failure';

            // If the checks were skipped on a merge queue, mark them as success
            } else if ('${{ inputs.event_name }}' === 'merge_group') {
              state = 'success';

            } else {
              state = 'error';
              description = 'Unexpected event ${{ inputs.event_name }} for skipped checks';
            }

          } else {
            state = 'error';
            description = 'Required checks completed with unexpected result';
          }

          await github.rest.repos.createCommitStatus({
            owner: context.repo.owner,
            repo: context.repo.repo,
            sha: '${{ inputs.commit-sha }}',
            state: state,
            target_url: `${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`,
            description: description,
            context: '${{ inputs.name }}'
          });
            
          console.log(`Set commit status: ${state} - ${description}`);
