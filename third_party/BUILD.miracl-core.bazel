load("@bazel_skylib//rules:run_binary.bzl", "run_binary")
load("@rules_cc//cc:defs.bzl", "cc_library")
load("@rules_python//python:defs.bzl", "py_binary")

py_binary(
    name = "generate",
    srcs = ["c/config64.py"],
    data = [],
    main = "c/config64.py",
    deps = [],
)

run_binary(
    name = "cbits",
    srcs = glob([
        "c/*.c",
        "c/*.h",
    ]),
    outs = [
        "aes.c",
        "arch.h",
        "big_384_58.c",
        "big_384_58.h",
        "bls_BLS12381.c",
        "bls_BLS12381.h",
        "config_big_384_58.h",
        "config_curve_BLS12381.h",
        "config_field_BLS12381.h",
        "core.h",
        "ecdh_BLS12381.h",
        "ecp2_BLS12381.c",
        "ecp2_BLS12381.h",
        "ecp_BLS12381.c",
        "ecp_BLS12381.h",
        "fp12_BLS12381.c",
        "fp12_BLS12381.h",
        "fp2_BLS12381.c",
        "fp2_BLS12381.h",
        "fp4_BLS12381.c",
        "fp4_BLS12381.h",
        "fp_BLS12381.c",
        "fp_BLS12381.h",
        "gcm.c",
        "hash.c",
        "hmac.c",
        "hpke_BLS12381.h",
        "mpin_BLS12381.h",
        "newhope.c",
        "newhope.h",
        "oct.c",
        "pair_BLS12381.c",
        "pair_BLS12381.h",
        "rand.c",
        "randapi.c",
        "randapi.h",
        "rom_curve_BLS12381.c",
        "rom_field_BLS12381.c",
        "share.c",
        "x509.h",
    ],
    args = [
        "--options=31",
        "--path=$(location c/arch.h)",
        "--output-path=$(location arch.h)",
    ],
    target_compatible_with = ["@platforms//os:linux"],
    tool = ":generate",
    visibility = ["//visibility:public"],
)

cc_library(
    name = "lib",
    srcs = [
        ":aes.c",
        ":big_384_58.c",
        ":bls_BLS12381.c",
        ":ecp2_BLS12381.c",
        ":ecp_BLS12381.c",
        ":fp12_BLS12381.c",
        ":fp2_BLS12381.c",
        ":fp4_BLS12381.c",
        ":fp_BLS12381.c",
        ":gcm.c",
        ":hash.c",
        ":hmac.c",
        ":newhope.c",
        ":oct.c",
        ":pair_BLS12381.c",
        ":rand.c",
        ":randapi.c",
        ":rom_curve_BLS12381.c",
        ":rom_field_BLS12381.c",
        ":share.c",
    ],
    hdrs = [
        ":arch.h",
        ":big_384_58.h",
        ":bls_BLS12381.h",
        ":config_big_384_58.h",
        ":config_curve_BLS12381.h",
        ":config_field_BLS12381.h",
        ":core.h",
        ":ecdh_BLS12381.h",
        ":ecp2_BLS12381.h",
        ":ecp_BLS12381.h",
        ":fp12_BLS12381.h",
        ":fp2_BLS12381.h",
        ":fp4_BLS12381.h",
        ":fp_BLS12381.h",
        ":hpke_BLS12381.h",
        ":mpin_BLS12381.h",
        ":newhope.h",
        ":pair_BLS12381.h",
        ":randapi.h",
        ":x509.h",
    ],
    includes = [":cbits"],
    target_compatible_with = ["@platforms//os:linux"],
    visibility = ["//visibility:public"],
)
