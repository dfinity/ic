load("//rs/tests:common.bzl", "IC_GATEWAY_DATA", "MAINNET_ENV", "NNS_CANISTER_RUNTIME_DEPS", "SNS_CANISTER_RUNTIME_DEPS")
load("//rs/tests:system_tests.bzl", "system_test", "system_test_nns")

package(default_visibility = ["//rs:system-tests-pkg"])

IC_GATEWAY_UVM_IMAGE = [
    "//rs/tests:ic_gateway_uvm_config_image",
]

# the "_test" postfixes in names are dropped on purpose since this target is meant for interactive use.

system_test(
    name = "single_large_node",
    enable_metrics = True,
    tags = [
        "dynamic_testnet",
        "manual",
    ],
    visibility = ["//visibility:public"],  # public because part of top-level manual test suite
    deps = [
        # Keep sorted.
        "//rs/registry/subnet_type",
        "//rs/tests/driver:ic-system-test-driver",
        "@crate_index//:anyhow",
    ],
)

system_test(
    name = "single_app_large_node",
    enable_metrics = True,
    tags = [
        "dynamic_testnet",
        "manual",
    ],
    deps = [
        # Keep sorted.
        "//rs/registry/subnet_type",
        "//rs/tests/driver:ic-system-test-driver",
        "@crate_index//:anyhow",
    ],
)

system_test_nns(
    name = "single_app_large_node_with_nns",
    enable_metrics = True,
    tags = [
        "dynamic_testnet",
        "manual",
    ],
    deps = [
        # Keep sorted.
        "//rs/registry/subnet_type",
        "//rs/tests/consensus/utils",
        "//rs/tests/driver:ic-system-test-driver",
        "@crate_index//:anyhow",
    ],
)

system_test(
    name = "single_app_small_node",
    enable_metrics = True,
    tags = [
        "dynamic_testnet",
        "manual",
    ],
    deps = [
        # Keep sorted.
        "//rs/registry/subnet_type",
        "//rs/tests/driver:ic-system-test-driver",
        "@crate_index//:anyhow",
    ],
)

system_test_nns(
    name = "small",
    data = IC_GATEWAY_UVM_IMAGE,
    enable_metrics = True,
    tags = [
        "dynamic_testnet",
        "manual",
    ],
    deps = [
        # Keep sorted.
        "//rs/registry/subnet_type",
        "//rs/tests/consensus/utils",
        "//rs/tests/driver:ic-system-test-driver",
        "@crate_index//:anyhow",
    ],
)

system_test_nns(
    name = "small_bitcoin",
    data = IC_GATEWAY_UVM_IMAGE,
    enable_metrics = True,
    tags = [
        "dynamic_testnet",
        "manual",
    ],
    deps = [
        # Keep sorted.
        "//rs/registry/subnet_type",
        "//rs/tests/consensus/utils",
        "//rs/tests/driver:ic-system-test-driver",
        "@crate_index//:anyhow",
        "@crate_index//:slog",
    ],
)

system_test_nns(
    name = "small_high_perf",
    data = IC_GATEWAY_UVM_IMAGE,
    enable_metrics = True,
    tags = [
        "dynamic_testnet",
        "manual",
    ],
    deps = [
        # Keep sorted.
        "//rs/registry/subnet_type",
        "//rs/tests/consensus/utils",
        "//rs/tests/driver:ic-system-test-driver",
        "@crate_index//:anyhow",
        "@crate_index//:slog",
    ],
)

system_test(
    name = "from_config",
    tags = [
        "dynamic_testnet",
        "manual",
    ],
    runtime_deps = NNS_CANISTER_RUNTIME_DEPS,
    deps = [
        "//rs/tests/dre/utils:os_qualification_utils",
        "//rs/tests/driver:ic-system-test-driver",
        "@crate_index//:anyhow",
        "@crate_index//:serde_json",
    ],
)

system_test_nns(
    name = "small_nns",
    data = IC_GATEWAY_UVM_IMAGE,
    enable_metrics = True,
    tags = [
        "dynamic_testnet",
        "manual",
    ],
    runtime_deps = {
        "IC_ICRC1_LEDGER_WASM_PATH": "//rs/ledger_suite/icrc1/ledger:ledger_canister",
        "II_WASM_PATH": "@ii_dev_canister//file",
        "NNS_DAPP_WASM_PATH": "@nns_dapp_canister//file",
        "SUBNET_RENTAL_WASM_PATH": "@subnet_rental_canister//file",
    },
    deps = [
        # Keep sorted.
        "//rs/registry/subnet_type",
        "//rs/tests/consensus/utils",
        "//rs/tests/driver:ic-system-test-driver",
        "//rs/tests/nns/nns_dapp",
        "@crate_index//:anyhow",
    ],
)

system_test_nns(
    name = "small_with_query_stats",
    data = IC_GATEWAY_UVM_IMAGE,
    enable_metrics = True,
    tags = [
        "dynamic_testnet",
        "manual",
    ],
    runtime_deps = {
        "IC_ICRC1_LEDGER_WASM_PATH": "//rs/ledger_suite/icrc1/ledger:ledger_canister",
        "II_WASM_PATH": "@ii_dev_canister//file",
        "NNS_DAPP_WASM_PATH": "@nns_dapp_canister//file",
        "SUBNET_RENTAL_WASM_PATH": "@subnet_rental_canister//file",
    },
    deps = [
        # Keep sorted.
        "//rs/registry/subnet_type",
        "//rs/tests/consensus/utils",
        "//rs/tests/driver:ic-system-test-driver",
        "@crate_index//:anyhow",
    ],
)

system_test_nns(
    name = "sns_testing",
    data = IC_GATEWAY_UVM_IMAGE,
    enable_metrics = True,
    tags = [
        "dynamic_testnet",
        "manual",
    ],
    runtime_deps = SNS_CANISTER_RUNTIME_DEPS | {
        "II_WASM_PATH": "@ii_dev_canister//file",
        "NNS_DAPP_WASM_PATH": "@nns_dapp_canister//file",
        "SNS_AGGREGATOR_WASM_PATH": "@sns_aggregator//file",
        "SUBNET_RENTAL_WASM_PATH": "@subnet_rental_canister//file",
    },
    deps = [
        # Keep sorted.
        "//rs/registry/subnet_type",
        "//rs/tests/consensus/utils",
        "//rs/tests/driver:ic-system-test-driver",
        "//rs/tests/nns/nns_dapp",
        "@crate_index//:anyhow",
        "@crate_index//:slog",
    ],
)

system_test_nns(
    name = "medium",
    data = IC_GATEWAY_UVM_IMAGE,
    enable_metrics = True,
    tags = [
        "dynamic_testnet",
        "manual",
    ],
    deps = [
        # Keep sorted.
        "//rs/registry/subnet_type",
        "//rs/tests/consensus/utils",
        "//rs/tests/driver:ic-system-test-driver",
        "@crate_index//:anyhow",
    ],
)

system_test_nns(
    name = "large",
    enable_metrics = True,
    tags = [
        "dynamic_testnet",
        "manual",
    ],
    runtime_deps = SNS_CANISTER_RUNTIME_DEPS | {
        "II_WASM_PATH": "@ii_dev_canister//file",
        "NNS_DAPP_WASM_PATH": "@nns_dapp_canister//file",
        "SNS_AGGREGATOR_WASM_PATH": "@sns_aggregator//file",
        "SUBNET_RENTAL_WASM_PATH": "@subnet_rental_canister//file",
    },
    deps = [
        # Keep sorted.
        "//rs/registry/subnet_type",
        "//rs/tests/consensus/utils",
        "//rs/tests/driver:ic-system-test-driver",
        "//rs/tests/nns/nns_dapp",
        "@crate_index//:anyhow",
    ],
)

system_test_nns(
    name = "io_perf_benchmark",
    data = IC_GATEWAY_UVM_IMAGE,
    enable_metrics = True,
    prometheus_vm_required_host_features = ["performance"],
    tags = [
        "dynamic_testnet",
        "manual",
    ],
    deps = [
        # Keep sorted.
        "//rs/registry/subnet_type",
        "//rs/tests/consensus/utils",
        "//rs/tests/driver:ic-system-test-driver",
        "//rs/tests/nns/nns_dapp",
        "@crate_index//:anyhow",
        "@crate_index//:slog",
    ],
)

system_test_nns(
    name = "src_testing",
    data = IC_GATEWAY_UVM_IMAGE,
    enable_metrics = True,
    tags = [
        "dynamic_testnet",
        "manual",
    ],
    runtime_deps = SNS_CANISTER_RUNTIME_DEPS | {
        "XRC_WASM_PATH": "//rs/rust_canisters/xrc_mock:xrc_mock_canister",
        "II_WASM_PATH": "@ii_dev_canister//file",
        "NNS_DAPP_WASM_PATH": "@nns_dapp_canister//file",
        "SNS_AGGREGATOR_WASM_PATH": "@sns_aggregator//file",
        "SUBNET_RENTAL_WASM_PATH": "@subnet_rental_canister//file",
    },
    deps = [
        # Keep sorted.
        "//rs/registry/subnet_features",
        "//rs/registry/subnet_type",
        "//rs/rust_canisters/xrc_mock",
        "//rs/tests/consensus/utils",
        "//rs/tests/driver:ic-system-test-driver",
        "//rs/tests/nns/nns_dapp",
        "//rs/types/base_types",
        "@crate_index//:anyhow",
        "@crate_index//:candid",
        "@crate_index//:ic-xrc-types",
    ],
)

system_test_nns(
    name = "nns_recovery",
    data = IC_GATEWAY_DATA,
    enable_metrics = True,
    guestos_update = "test",
    tags = [
        "dynamic_testnet",
        "manual",
    ],
    uses_setupos_img = True,
    deps = [
        # Keep sorted.
        "//rs/limits",
        "//rs/tests/consensus/subnet_recovery:lib",
        "//rs/tests/driver:ic-system-test-driver",
        "//rs/tests/nested",
        "//rs/tests/nested/nns_recovery:common",
        "@crate_index//:anyhow",
        "@crate_index//:slog",
    ],
)

system_test_nns(
    name = "mainnet_nns",
    data = IC_GATEWAY_DATA + ["//rs/tests:recovery/binaries"],
    env = MAINNET_ENV,
    enable_metrics = True,
    env_inherit = ["SSH_AUTH_SOCK"],
    guestos = "mainnet_nns",
    # Requires more resources to scrape mainnet topology
    prometheus_vm_resources = {
        "vcpus": 32,
        "memory_kibibytes": 125000000,
        "boot_image_minimal_size_gibibytes": 500,
    },
    tags = [
        "dynamic_testnet",
        "manual",
    ],
    runtime_deps = {
        # TODO (CON-1624): Remove those dependencies once #8170 reached mainnet NNS
        "IC_RECOVERY_PATH": "//rs/recovery:ic-recovery",
        "IC_REPLAY_PATH": "//rs/replay:ic-replay",
    },
    deps = [
        # Keep sorted.
        "//rs/tests/driver:ic-system-test-driver",
        "//rs/tests/testnets/mainnet_nns:lib",
        "@crate_index//:anyhow",
    ],
)
