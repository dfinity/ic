load("@rules_rust//rust:defs.bzl", "rust_library", "rust_proc_macro", "rust_test")

package(default_visibility = ["//visibility:public"])

rust_library(
    name = "tla_instrumentation",
    srcs = glob(["tla_instrumentation/src/**/*.rs"]),
    crate_name = "tla_instrumentation",
    deps = [
        "@crate_index//:candid",
        "@crate_index//:serde",
        "@crate_index//:sha2",
        "@crate_index//:uuid",
    ],
)

rust_library(
    name = "local_key",
    srcs = glob(["local_key/src/**/*.rs"]),
    crate_name = "local_key",
    deps = [
        "@crate_index//:pin-project-lite",
    ],
)

rust_test(
    name = "tla_instrumentation_test",
    srcs = glob(["tla_instrumentation/tests/**/*.rs"]),
    data = [
        ":tla_modules",
        "@bazel_tools//tools/jdk:current_java_runtime",
        "@tla_apalache//:bin/apalache-mc",
    ],
    env = {
        "JAVABASE": "$(JAVABASE)",
        "TLA_APALACHE_BIN": "$(rootpath @tla_apalache//:bin/apalache-mc)",
        "TLA_MODULES": "$(locations :tla_modules)",
    },
    proc_macro_deps = [":proc_macros"],
    toolchains = ["@bazel_tools//tools/jdk:current_java_runtime"],
    deps = [
        ":local_key",
        ":tla_instrumentation",
        "@crate_index//:candid",
        "@crate_index//:tokio-test",
    ],
)

# all TLA modules
# NOTE: the test runner assumes unique basenames
filegroup(
    name = "tla_modules",
    srcs = glob(["tla/*.tla"]),
)

rust_proc_macro(
    name = "proc_macros",
    srcs = glob(["tla_instrumentation_proc_macros/src/**/*.rs"]),
    crate_name = "tla_instrumentation_proc_macros",
    deps = [
        "@crate_index//:proc-macro2",
        "@crate_index//:quote",
        "@crate_index//:syn",
    ],
)
