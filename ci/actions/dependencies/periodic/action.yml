name: 'Dependency Scan Nightly'
runs:
  using: "composite"
  steps:
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: "3.12"
    - name: Setup environment deps
      id: setup-environment-deps
      shell: bash
      working-directory: ${{ github.action_path }}/../../../..
      run: |
        # this is needed to get more free space on the runner, otherwise might run OOM when building icOS
        rm -rf /opt/hostedtoolcache
        # Ignore externally-managed-environment pip error, install packages system-wide.
        PIP_BREAK_SYSTEM_PACKAGES=1 pip3 install --ignore-installed -r requirements.txt
    - name: Run Dependency Scan Nightly
      id: dependency-scan-nightly
      shell: bash
      working-directory: ${{ github.action_path }}/../../../..
      run: |
        set -euo pipefail
        export PYTHONPATH=$PWD/ci/src:$PWD/ci/src/dependencies
        cd ci/src/dependencies/
        cp -a $GITHUB_WORKSPACE/config/. config/
        $SHELL_WRAPPER python3 job/bazel_trivy_container_ic_scanner_periodic_job.py
        df -h
      env:
        SHELL_WRAPPER: "/usr/bin/time"
        CI_PIPELINE_ID: ${{ github.run_id }}
